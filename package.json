const message = text.toLowerCase().trim();
const from = phone;

if (!userState[from]) {
  userState[from] = {};
}

/* STEP A: MENU SELECTION */
if (!userState[from].step) {
  if (message === '1') {
    userState[from] = { step: 'qty', product: 'Buffalo Milk', price: 100 };
    reply = 'ü•õ Buffalo Milk selected.\nHow many liters?';
  } 
  else if (message === '2') {
    userState[from] = { step: 'qty', product: 'Cow Milk', price: 120 };
    reply = 'ü•õ Cow Milk selected.\nHow many liters?';
  }
  else {
    reply = `Welcome to Bala Milk Store ü•õ
1Ô∏è‚É£ Buffalo Milk ‚Äì ‚Çπ100/L
2Ô∏è‚É£ Cow Milk ‚Äì ‚Çπ120/L
3Ô∏è‚É£ Paneer ‚Äì ‚Çπ600/Kg
4Ô∏è‚É£ Ghee ‚Äì ‚Çπ1000/Kg
Reply with option number.`;
  }
}

/* STEP B: QUANTITY */
else if (userState[from].step === 'qty') {
  const qty = parseInt(message);
  if (isNaN(qty) || qty <= 0) {
    reply = 'Please enter a valid quantity.';
  } else {
    const total = qty * userState[from].price;

    reply = `‚úÖ Order Confirmed
Product: ${userState[from].product}
Quantity: ${qty}
Total: ‚Çπ${total}

Thank you! üôè`;

    // store order later (Google Sheets)
    userState[from] = {}; // reset
  }
}
